# M2S8 Особенности Express [28.05.24]
## [express middleware](https://expressjs.com/en/guide/using-middleware.html)

> Код, который выполняется перед/после запроса. 

Middleware на уровне приложения (Application level)
```javascript
app.use((req,res,next) => {
	console.log('middleware 1 start')
	next()
	console.log('middleware 1 end')
	res.on('finish', () => {
		console.log('after request');
	}
}
```
Middleware можно представить как скорлупу.
m1 - middleware 1
m2 - middleware 2
get - route (*app.get*)
req - request
res - response
Пример запроса с 2мя middleware
**=req=>(m1(m2()m2)m1)=res=>**
Когда мы используем метод `next()` мы попадаем в следующий middleware в стеке, если next() не произдет мы повисним в этой middleware.
Также можно не опускаться ниже, а выйти вверх сразу из middleware с помощью `res.send`: 
```javascript
app.get('/user/:id', (req, res, next) => {
  // if the user ID is 0, skip to the next route
  if (req.params.id === '0') next('route')
  // otherwise pass the control to the next middleware function in this stack
  else next()
}, (req, res, next) => {
  // send a regular response
  res.send('regular')
})

// handler for the /user/:id path, which sends a special response
app.get('/user/:id', (req, res, next) => {
  res.send('special')
})
```
 Можно пропустить вложенный мидлвер, сразу перейдя к route с помощью `next('route')`:
 ```javascript
app.get('/user/:id', (req, res, next) => {
  // if the user ID is 0, skip to the next route
  if (req.params.id === '0') next('route')
  // otherwise pass the control to the next middleware function in this stack
  else next()
}, (req, res, next) => {
  // send a regular response
  res.send('regular')
})
```
## CORS (Cross Origin Resource Sharing)
Браузер ограничивает выполнение запросов между разными доменами.
Библиотека [cors](https://www.npmjs.com/package/cors) позволяет управлять настройками **CORS**. 
 ```javascript
const  corsSettingsRoute = {
origin:'http://localhost:3000', // ограничиваем доступ только с 3000
};
const corsSettingsRouter = {
origin:'http://localhost:3001', // ограничиваем доступ только с 3001
}
router.use(cors(corsSettingsRouter));   //обработка на уровне роутер с настройками corsSettingsRouter 
router.get('/', (req, res) => { 
res.send('ok');
})
router.post('/', cors(corsSettingsRoute), (req, res) => { //обработка на уровне этого запроса с настройками corsSettingsRoute 
res.send('ok');
})
router.put('/', (req, res) => {
res.send('ok');
})
```
 [Шпаргалка по конфигурации CORS](https://my-js.org/docs/cheatsheet/cors/) 
## Парсеры